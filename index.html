<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>تطبيق الدردشة المتطور</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #6c63ff;
            --primary-dark: #564fd6;
            --secondary-color: #4a44b5; /* Used for Rooms button */
            --accent-color: #ff6b6b;
            --background-color: #f5f7fb;
            --surface-color: #ffffff;
            --text-color: #2d3748;
            --text-light: #718096;
            --sent-message-bg: linear-gradient(135deg, #6c63ff, #4a44b5);
            --received-message-bg: #edf2e7;
            --online-status: #48bb78;
            --offline-status: #a0aec0;
            --font-family: 'Cairo', sans-serif;
            --border-radius-md: 14px;
            --border-radius-lg: 24px;
            --box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --footer-height: 40px; 
            --extra-scroll-bottom-space: 0px; /* تم التعديل هنا */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            transition: var(--transition);
            padding-bottom: calc(var(--footer-height) + var(--extra-scroll-bottom-space));
        }
        .page-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }

        /* --- Auth Page Styles --- */
        .auth-wrapper { background-color: var(--surface-color); padding: 35px 45px 65px 45px; border-radius: var(--border-radius-md); box-shadow: var(--box-shadow); width: 100%; max-width: 500px; text-align: center; position: relative; overflow: hidden; transition: var(--transition); }
        .auth-wrapper::before { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); }
        .auth-wrapper h1 { color: var(--primary-color); margin-bottom: 25px; font-weight: 700; font-size: 2.2rem; position: relative; display: inline-block; padding-bottom: 10px; }
        .auth-wrapper h1::after { content: ''; position: absolute; bottom: 0; left: 0; width: 50%; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 2px; }
        .form-group { margin-bottom: 22px; text-align: right; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-color); font-size: 1.05rem; }
        .form-group input[type="text"], .form-group input[type="password"], .form-group input[type="tel"] { width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: var(--border-radius-md); font-size: 16px; font-family: var(--font-family); transition: var(--transition); background: #f8fafc; }
        .form-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.2); outline: none; background: white; }
        .form-group-checkbox { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 20px; gap: 10px; }
        .form-group-checkbox label { margin-bottom: 0; font-size: 1rem; }
        .form-group-checkbox input[type="checkbox"] { width: auto; accent-color: var(--primary-color); }

        .gender-selection { display: flex; gap: 20px; margin-top: 8px; }
        .gender-option { flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: var(--border-radius-md); text-align: center; cursor: pointer; transition: var(--transition); background: #f8fafc; }
        .gender-option.selected { border-color: var(--primary-color); background: rgba(108, 99, 255, 0.08); box-shadow: 0 4px 12px rgba(108, 99, 255, 0.1); }
        .gender-option i { font-size: 1.8rem; margin-bottom: 10px; color: var(--text-light); }
        .gender-option.selected i { color: var(--primary-color); }
        .gender-option span { font-weight: 600; color: var(--text-light); }
        .gender-option.selected span { color: var(--primary-color); }
        .avatar-selection { margin-top: 15px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .avatar-option { width: 85px; height: 85px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 3px solid transparent; transition: var(--transition); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .avatar-option.selected { border-color: var(--primary-color); transform: scale(1.1); box-shadow: 0 0 20px rgba(108, 99, 255, 0.4); }
        .avatar-option:hover { transform: scale(1.05); border-color: #cbd5e0; }
        button, .action-button { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 15px 25px; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-size: 17px; font-family: var(--font-family); font-weight: 600; transition: var(--transition); width: 100%; -webkit-tap-highlight-color: transparent; box-shadow: 0 4px 14px rgba(108, 99, 255, 0.35); position: relative; overflow: hidden; }
        button::after, .action-button::after { content: ''; position: absolute; top: -50%; left: -60%; width: 20px; height: 200%; background: rgba(255, 255, 255, 0.3); transform: rotate(25deg); transition: all 0.4s; }
        button:hover::after, .action-button:hover::after { left: 120%; }
        button:hover, .action-button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(108, 99, 255, 0.45); }
        button:active, .action-button:active { transform: translateY(1px); }
        .toggle-form { margin-top: 25px; font-size: 15px; color: var(--text-light); }
        .toggle-form a { color: var(--primary-color); text-decoration: none; font-weight: bold; position: relative; }
        .toggle-form a::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: var(--primary-color); transition: var(--transition); }
        .toggle-form a:hover::after { width: 100%; }
        .error-message, .success-message { margin-bottom: 20px; padding: 14px; border-radius: var(--border-radius-md); font-size: 15px; border: 1px solid transparent; text-align: center; }
        .error-message { color: #b91c1c; background-color: #fee2e2; border-color: #fecaca; }
        .success-message { color: #166534; background-color: #dcfce7; border-color: #bbf7d0; }
        .hidden { display: none !important; }

        /* --- Chat Page Styles --- */
        .chat-page-container { display: flex; height: 95vh; width: 90vw; max-width: 1400px; background-color: var(--surface-color); box-shadow: var(--box-shadow); border-radius: var(--border-radius-md); overflow: hidden; margin: 2.5vh auto; position: relative; transition: var(--transition); }
        .sidebar { width: 320px; background-color: #f8fafc; border-right: 1px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; position: relative; transition: var(--transition); transform: translateX(100%); }
        html[dir="rtl"] .sidebar { transform: translateX(-100%); border-left: 1px solid #e2e8f0; border-right: none; }
        .sidebar.sidebar-visible-mobile { transform: translateX(0) !important; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 1000; position: fixed; top: 0; height: 100vh; }
        html[dir="ltr"] .sidebar.sidebar-visible-mobile { right: 0; left: auto; }
        html[dir="rtl"] .sidebar.sidebar-visible-mobile { left: 0; right: auto; }


        .user-profile { display: flex; flex-direction: column; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 0px; }
        .user-profile-main-info { display: flex; align-items: center; width: 100%; margin-bottom: 15px; }
        .avatar-wrapper { position: relative; margin-left: 15px; }
        #user-avatar-sidebar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); box-shadow: 0 4px 8px rgba(108, 99, 255, 0.2); display: block; }
        .user-profile .status { position: absolute; bottom: 3px; right: 3px; width: 14px; height: 14px; background-color: var(--online-status); border-radius: 50%; border: 2px solid var(--surface-color); }
        #user-name-sidebar { font-weight: 700; font-size: 1.15rem; color: var(--text-color); }
        #logout-button-sidebar { background: var(--accent-color); width: 100%; padding: 10px 15px; font-size: 15px; }
        #logout-button-sidebar:hover { background: #e65c5c; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); transform: translateY(-2px); }
        
        .active-chats-container { padding-top: 15px; margin-top: 15px; border-top: 1px solid #e2e8f0; flex-grow: 1; }
        .active-chats-container h2 { font-size: 1rem; color: var(--text-light); margin-bottom: 10px; padding: 0 5px; }
        .private-chat-avatar-item { display: flex; align-items: center; padding: 8px 5px; border-radius: var(--border-radius-md); margin-bottom: 5px; cursor: pointer; transition: var(--transition); }
        .private-chat-avatar-item:hover, .private-chat-avatar-item.active-priv-chat { background-color: rgba(108, 99, 255, 0.1); }
        .private-chat-avatar-item img { width: 35px; height: 35px; border-radius: 50%; margin-left: 10px; object-fit: cover; border: 2px solid transparent; }
        .private-chat-avatar-item.active-priv-chat img { border-color: var(--primary-color); }
        .private-chat-avatar-item span { font-size: 0.9rem; font-weight: 500; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .scrollable-y { overflow-y: auto; max-height: calc(100% - 40px); /* Adjust if needed based on sibling elements */ }

        .chat-area { flex-grow: 1; display: flex; flex-direction: column; padding: 0; background-color: var(--background-color); position: relative; }
        .chat-header { padding: 18px 25px; border-bottom: 1px solid #e2e8f0; background-color: var(--surface-color); display: flex; justify-content: space-between; align-items: center; min-height: 70px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); z-index: 5; position: relative; }
        .chat-header h3 { margin: 0; flex-grow: 1; text-align: center; font-weight: 700; font-size: 1.3rem; color: var(--text-color); }
        .header-button { background: none; border: none; color: var(--primary-color); font-size: 1.5rem; cursor: pointer; padding: 5px; line-height: 1; width: 30px; text-align: center; flex-shrink: 0; }
        .header-button:hover { color: var(--primary-dark); }
        #settings-menu-toggle-mobile { display: none; } 

        .settings-dropdown { position: absolute; top: calc(100% + 5px); background-color: var(--surface-color); border-radius: var(--border-radius-md); box-shadow: var(--box-shadow); z-index: 100; width: 200px; overflow: hidden; transition: opacity 0.2s ease, transform 0.2s ease; opacity: 0; transform: translateY(-10px); pointer-events: none; }
        html[dir="ltr"] .settings-dropdown { left: 15px; } 
        html[dir="rtl"] .settings-dropdown { right: 15px; } 
        .settings-dropdown.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .settings-dropdown-item { display: flex; align-items: center; padding: 12px 18px; font-size: 0.95rem; color: var(--text-color); cursor: pointer; transition: background-color 0.2s; }
        .settings-dropdown-item:hover { background-color: var(--background-color); }
        .settings-dropdown-item i { margin-left: 12px; color: var(--text-light); font-size: 1.1em; }
        html[dir="rtl"] .settings-dropdown-item i { margin-left: 0; margin-right: 12px; }
        .settings-dropdown-item.logout i { color: var(--accent-color); }

        .active-chats-container-mobile { display: none; align-items: center; gap: 8px; overflow-x: auto; padding: 0 5px; flex-shrink: 1; min-width: 0; margin: 0 10px; }
        .active-chats-container-mobile .private-chat-avatar-item { padding: 0; margin-bottom: 0; }
        .active-chats-container-mobile .private-chat-avatar-item img { width: 30px; height: 30px; margin-left: 0; }
        .active-chats-container-mobile .private-chat-avatar-item.active-priv-chat img { border: 2px solid var(--primary-color); box-shadow: 0 0 5px var(--primary-color); }
        .active-chats-container-mobile .private-chat-avatar-item span { display: none; }
        .scrollable-x { overflow-x: auto; white-space: nowrap; }
        .scrollable-x::-webkit-scrollbar { height: 3px; }
        .scrollable-x::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px;}

        #chat-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* === START OF WHATSAPP STYLE MODIFICATIONS === */
        .messages-container {
            flex-grow: 1;
            padding: 10px;
            padding-bottom: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px; /* تم التعديل: زيادة المسافة بين الرسائل */
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none"/><path d="M20,20 Q40,5 50,30 T80,20" fill="none" stroke="rgba(108, 99, 255, 0.03)" stroke-width="0.5"/></svg>');
            background-size: 300px;
        }

        .message {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 8px;
            line-height: 1.45;
            font-size: 15px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            animation: messageAppear 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        @keyframes messageAppear { to { opacity: 1; transform: translateY(0); } }

        .message .sender-info-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .message.sent .sender-info-container { cursor: default; }
        .message.received .sender-info-container:hover .name { text-decoration: underline; color: var(--primary-dark); }
        .message .sender-info-container img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 10px;
            object-fit: cover;
        }
        .message .sender-info-container .name {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--primary-color);
        }

        .message .message-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 75px; /* تم التعديل: زيادة المسافة للوقت */
        }
        .message .message-text {
             white-space: pre-wrap;
             flex-grow: 1;
        }

        .message .delete-msg-icon {
            font-size: 0.9em;
            color: rgba(0,0,0,0.4);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px;
            border-radius: 50%;
        }
        .message .delete-msg-icon:hover {
            color: var(--accent-color);
            background: rgba(0,0,0,0.05);
        }

        .message .timestamp {
            font-size: 0.7em;
            color: #667781;
            position: absolute;
            bottom: 6px;
            right: 12px;
        }

        /* --- Sent Message (WhatsApp Green) --- */
        .message.sent {
            background-color: #dcf8c6;
            color: #111b21;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        .message.sent::after {
            content: '';
            position: absolute;
            top: 0;
            right: -7px;
            width: 8px;
            height: 13px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 8 13" width="8" height="13" xmlns="http://www.w3.org/2000/svg"><path d="M8,0 C5,0 5,2 3,2 C2,2 0,4 0,6 L8,13 L8,0 Z" fill="%23dcf8c6"></path></svg>');
        }
        .message.sent .message-content {
            padding-right: 0;
            padding-left: 75px; /* تم التعديل: زيادة المسافة للوقت */
        }
        .message.sent .timestamp {
            right: auto;
            left: 12px;
        }

        /* --- Received Message (White) --- */
        .message.received {
            background-color: #ffffff;
            color: #111b21;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        .message.received::after {
            content: '';
            position: absolute;
            top: 0;
            left: -7px;
            width: 8px;
            height: 13px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 8 13" width="8" height="13" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 C3,0 3,2 5,2 C6,2 8,4 8,6 L0,13 L0,0 Z" fill="%23ffffff"></path></svg>');
        }

        .ban-user-icon { font-size: 0.9em; color: var(--accent-color); cursor: pointer; transition: var(--transition); padding: 4px; }
        .ban-user-icon:hover { transform: scale(1.15); color: var(--primary-dark); }
        html[dir="rtl"] .sender-info-container .ban-user-icon { margin-left: 0; margin-right: 8px; }
        html[dir="ltr"] .sender-info-container .ban-user-icon { margin-right: 0; margin-left: 8px; }
        /* === END OF WHATSAPP STYLE MODIFICATIONS === */

        .message-input-area { display: flex; align-items: center; padding: 18px; border-top: 1px solid #e2e8f0; background-color: var(--surface-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        #message-input { flex-grow: 1; padding: 16px 22px; border: 2px solid #e2e8f0; border-radius: var(--border-radius-lg); margin-left: 15px; font-size: 15.5px; font-family: var(--font-family); resize: none; line-height: 1.6; transition: var(--transition); max-height: 150px; overflow-y: auto; background: #f8fafc; }
        #message-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.2); outline: none; background: white; }
        #send-button { padding: 0; border-radius: 50%; font-size: 20px; width: 55px; height: 55px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3); }
        
        /* --- Rooms Management View Styles --- */
        #rooms-management-view { display: flex; flex-direction: column; height: 100%; background-color: var(--background-color); padding: 20px; }
        .rooms-management-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
        .rooms-management-header h2 { font-size: 1.4rem; color: var(--text-color); margin: 0; }
        .rooms-management-header .action-button { width: auto; padding: 10px 20px; font-size: 0.95rem; }
        #rooms-list-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .room-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--surface-color); padding: 15px 20px; border-radius: var(--border-radius-md); box-shadow: 0 3px 8px rgba(0,0,0,0.08); cursor: pointer; transition: var(--transition); }
        .room-item:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.1); }
        .room-item-info { display: flex; align-items: center; gap: 12px; }
        .room-item-info i { font-size: 1.2rem; color: var(--primary-color); }
        .room-item-info .room-name { font-weight: 600; font-size: 1.05rem; }
        .room-item-info .room-creator { font-size: 0.8rem; color: var(--text-light); }
        .room-item .join-room-icon { font-size: 1.3rem; color: var(--primary-color); }
        .room-item .lock-icon { color: var(--accent-color); margin-left: 8px; font-size: 0.9rem; }
        html[dir="rtl"] .room-item .lock-icon { margin-left: 0; margin-right: 8px; }

        /* --- Modal Styles --- */
        .modal { position: fixed; z-index: 1005; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--surface-color); padding: 30px 35px; border-radius: var(--border-radius-md); box-shadow: var(--box-shadow); width: 90%; max-width: 450px; text-align: right; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-content h3 { color: var(--primary-color); margin-top: 0; margin-bottom: 25px; font-size: 1.6rem; text-align: center; }
        .close-modal-button { color: var(--text-light); position: absolute; top: 15px; left: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal-button:hover { color: var(--text-color); }
        .modal .form-group input { margin-bottom: 5px; }
        .modal .action-button { margin-top: 15px; }

        html[dir="rtl"] .avatar-wrapper { margin-left: 0; margin-right: 15px; }
        html[dir="rtl"] .private-chat-avatar-item img { margin-left: 0; margin-right: 10px; }
        html[dir="rtl"] .active-chats-container-mobile .private-chat-avatar-item img { margin-right: 0; }
        
        /* RTL Adjustments for WhatsApp Style */
        html[dir="rtl"] .message.sent { align-self: flex-start; border-top-left-radius: 0; border-top-right-radius: 8px; }
        html[dir="rtl"] .message.sent::after { transform: scaleX(-1); left: -7px; right: auto; }
        html[dir="rtl"] .message.received { align-self: flex-end; border-top-right-radius: 0; border-top-left-radius: 8px; }
        html[dir="rtl"] .message.received::after { transform: scaleX(-1); right: -7px; left: auto; }
        html[dir="rtl"] .message .sender-info-container img { margin-left: 0; margin-right: 8px; }
        html[dir="rtl"] .message.sent .timestamp { text-align: right; right: 12px; left: auto; }
        html[dir="rtl"] .message.received .timestamp { text-align: left; left: 12px; right: auto; }
        html[dir="rtl"] #message-input { margin-right: 10px; margin-left: 0; }
        html[dir="rtl"] .delete-msg-icon { margin-right: auto; margin-left: 0; }
        
        .chat-request-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--surface-color); color: var(--text-color); padding: 20px; border-radius: var(--border-radius-md); box-shadow: var(--box-shadow); z-index: 1001; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; max-width: 350px; border-top: 4px solid var(--primary-color); }
        .chat-request-notification p { margin: 0 0 10px 0; font-size: 1rem; }
        .chat-request-actions button { padding: 8px 15px; font-size: 0.9rem; margin: 0 5px; width: auto; }
        .chat-request-actions button.accept { background: var(--online-status); }
        .chat-request-actions button.reject { background: var(--accent-color); }

        .overlay-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.3); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .overlay-backdrop.active { opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            body { overflow: hidden; }
            .auth-wrapper { width: 90%; padding: 25px 25px 55px 25px; height: auto; max-height: 95vh; overflow-y: auto; }
            .chat-page-container { flex-direction: column; width: 100vw; height: 100%; margin: 0; border-radius: 0; box-shadow: none; }
            .sidebar { display: flex !important; position: fixed; top: 0; height: 100vh; width: 280px; z-index: 1005; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
            html[dir="ltr"] .sidebar { right: 0; transform: translateX(100%); }
            html[dir="rtl"] .sidebar { left: 0; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.sidebar-visible-mobile { transform: translateX(0) !important; }
            .chat-area { width: 100% !important; height: 100% !important; display: flex !important; position: static; }
            html[dir="rtl"] .chat-area { left: auto; right: auto; }
            .chat-header { padding: 12px 15px; min-height: 55px; }
            .chat-header h3 { font-size: 1.1em; order: 2; }
            #settings-menu-toggle-mobile { display: inline-block; order: 1; } 
            #public-chat-button { display: inline-block; order: 3; }
            .active-chats-container-mobile { display: flex; order: 0; margin: 0 5px; }
            html[dir="rtl"] .active-chats-container-mobile { order: 4; }
            .messages-container { padding: 12px; padding-bottom: 30px; }
            .message { max-width: 90%; font-size: 15px; padding: 12px 16px; }
            .message-input-area { padding: 12px; }
            #message-input { padding: 12px 16px; }
            #send-button { width: 48px; height: 48px; font-size: 18px; }
            #rooms-management-view { padding: 15px; }
            .rooms-management-header h2 { font-size: 1.2rem; }
            .rooms-management-header .action-button { padding: 8px 15px; font-size: 0.9rem; }
            .room-item { padding: 12px 15px; }
            .modal-content { padding: 20px 25px; }
            .modal-content h3 {font-size: 1.4rem; }
        }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: var(--border-radius-md); background: var(--surface-color); color: var(--text-color); box-shadow: var(--box-shadow); z-index: 1000; display: flex; align-items: center; gap: 12px; transform: translateY(-20px); opacity: 0; transition: var(--transition); }
        .notification.show { transform: translateY(0); opacity: 1; }
        .notification i { font-size: 1.4rem; }
        .notification.success { background: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .notification.error { background: #fee2e2; color: #b91c1c; border-left: 4px solid #ef4444; }
        
        .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(108, 99, 255, 0.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .site-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--footer-height); background-color: var(--surface-color); padding: 0; text-align: center; font-size: 0.9rem; font-family: var(--font-family); color: var(--text-light); border-top: 1px solid #e2e8f0; z-index: 999; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .site-footer i { color: var(--primary-color); font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="auth-page-container" class="page-container">
        <div class="auth-wrapper">
            <div id="register-form-section">
                <h1>إنشاء حساب جديد</h1>
                <div id="error-message-register" class="error-message hidden"></div>
                <div id="success-message-register" class="success-message hidden"></div>
                <form id="registrationForm">
                    <div class="form-group"><label for="reg-name">الاسم:</label><input type="text" id="reg-name" required placeholder="أدخل اسمك الكامل"></div>
                    <div class="form-group"><label for="reg-phone">رقم الهاتف:</label><input type="tel" id="reg-phone" required placeholder="سيكون اسم المستخدم"></div>
                    <div class="form-group"><label for="reg-password">كلمة المرور:</label><input type="password" id="reg-password" required placeholder="اختر كلمة مرور قوية"></div>
                    <div class="form-group"><label>الجنس:</label><div class="gender-selection"><div class="gender-option" data-gender="boy"><i class="fas fa-male"></i><span>ولد</span></div><div class="gender-option" data-gender="girl"><i class="fas fa-female"></i><span>بنت</span></div></div></div>
                    <div class="form-group avatar-selection hidden" id="boy-avatars"><p>اختر صورتك الرمزية (ولد):</p><img src="https://i.postimg.cc/sXQmJP2R/fe9a6fb8ec128b6613d5d241d940f175.jpg" alt="ولد 1" class="avatar-option" data-gender="boy"><img src="https://i.postimg.cc/1zzJ81hX/290c074a-fd05-4753-b065-70f429d62a2b.jpg" alt="ولد 2" class="avatar-option" data-gender="boy"><img src="https://i.postimg.cc/VNH4MZmR/2.jpg" alt="ولد 3" class="avatar-option" data-gender="boy"></div>
                    <div class="form-group avatar-selection hidden" id="girl-avatars"><p>اختر صورتك الرمزية (بنت):</p><img src="https://i.postimg.cc/76dsvsR6/FB-IMG-1748696673587.jpg" alt="بنت 1" class="avatar-option" data-gender="girl"><img src="https://i.postimg.cc/RFNsD5Xy/FB-IMG-1748696710009.jpg" alt="بنت 2" class="avatar-option" data-gender="girl"></div>
                    <input type="hidden" id="selected-avatar" name="selected-avatar"><button type="submit">تسجيل</button>
                </form><p class="toggle-form">لديك حساب بالفعل؟ <a href="#" id="show-login">سجل الدخول</a></p>
            </div>
            <div id="login-form-section" class="hidden"><h1>تسجيل الدخول</h1><div id="error-message-login" class="error-message hidden"></div><form id="loginForm"><div class="form-group"><label for="login-phone">رقم الهاتف:</label><input type="tel" id="login-phone" required placeholder="أدخل رقم هاتفك"></div><div class="form-group"><label for="login-password">كلمة المرور:</label><input type="password" id="login-password" required placeholder="أدخل كلمة المرور"></div><button type="submit">دخول</button></form><p class="toggle-form">ليس لديك حساب؟ <a href="#" id="show-register">أنشئ حساب جديد</a></p></div>
        </div>
    </div>

    <div id="chat-page-container" class="page-container chat-page-container hidden">
        <aside class="sidebar" id="main-sidebar">
            <div class="user-profile">
                <div class="user-profile-main-info">
                    <div class="avatar-wrapper">
                        <img id="user-avatar-sidebar" src="https://via.placeholder.com/50" alt="User Avatar">
                        <div class="status"></div>
                    </div>
                    <span id="user-name-sidebar">اسم المستخدم</span>
                </div>
                <button id="logout-button-sidebar" class="action-button">تسجيل الخروج</button>
            </div>
            <button id="show-rooms-page-button-sidebar" class="action-button" style="margin-top: 10px; background: var(--secondary-color); width:100%;">
                <i class="fas fa-door-open" style="margin-left: 8px;"></i> عرض الغرف
            </button>

            <div id="active-private-chats-sidebar" class="active-chats-container">
                <h2>محادثات خاصة</h2>
                <div class="scrollable-y">
                </div>
            </div>
        </aside>
        <main class="chat-area">
            <header class="chat-header">
                <button id="settings-menu-toggle-mobile" class="header-button"><i class="fas fa-cog"></i></button>
                <div id="active-private-chats-header" class="active-chats-container-mobile scrollable-x"></div>
                <h3 id="current-chat-name">الدردشة العامة</h3>
                <button id="public-chat-button" class="header-button"><i class="fas fa-globe-americas"></i></button>

                <div id="settings-dropdown-menu" class="settings-dropdown">
                    <div class="settings-dropdown-item" id="dropdown-show-chats">
                        <i class="fas fa-comments"></i>
                        <span>عرض الدردشات الخاصة</span>
                    </div>
                    <div class="settings-dropdown-item" id="dropdown-show-rooms-page">
                        <i class="fas fa-door-open"></i>
                        <span>عرض الغرف</span>
                    </div>
                    <div class="settings-dropdown-item logout" id="dropdown-logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </div>
                </div>
            </header>

            <div id="chat-content-wrapper">
                <div id="messages-container" class="messages-container">
                </div>
                
                <div id="rooms-management-view" class="hidden">
                    <div class="rooms-management-header">
                        <h2 id="rooms-management-title">الغرف المتاحة</h2>
                        <button id="show-create-room-modal-button" class="action-button">
                            <i class="fas fa-plus-circle" style="margin-left: 8px;"></i>إنشاء غرفة جديدة
                        </button>
                    </div>
                    <div id="rooms-list-container" class="scrollable-y">
                    </div>
                </div>
            </div>

            <div class="message-input-area">
                <textarea id="message-input" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
                <button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>
    
    <div class="site-footer">
        <span>سيف هاني</span>
        <i class="fas fa-laptop-code"></i>
    </div>
    <div id="overlay-backdrop" class="overlay-backdrop"></div>

    <div id="notification-center" class="hidden"><div id="notification" class="notification hidden"><i class="fas fa-info-circle"></i><span id="notification-text"></span></div></div>
    <div id="chat-request-notification-container"></div>

    <div id="create-room-modal" class="modal hidden"> <div class="modal-content">
            <span class="close-modal-button" id="close-create-room-modal-button">×</span>
            <h3>إنشاء غرفة جديدة</h3>
            <form id="create-room-form">
                <div id="error-message-create-room" class="error-message hidden" style="margin-bottom: 15px;"></div>
                <div class="form-group">
                    <label for="room-name-input">اسم الغرفة:</label>
                    <input type="text" id="room-name-input" required placeholder="مثال: محبي الألعاب">
                </div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="room-secret-checkbox">
                    <label for="room-secret-checkbox">غرفة سرية؟</label>
                </div>
                <div class="form-group hidden" id="room-secret-code-group">
                    <label for="room-secret-code-input">الرمز السري للغرفة:</label>
                    <input type="password" id="room-secret-code-input" placeholder="اتركه فارغًا لغرفة عامة غير سرية">
                </div>
                <button type="submit" class="action-button">إنشاء الغرفة</button>
            </form>
        </div>
    </div>

    <div id="enter-secret-code-modal" class="modal hidden"> <div class="modal-content">
            <span class="close-modal-button" id="close-enter-secret-code-modal-button">×</span>
            <h3 id="enter-secret-code-room-name-header">دخول غرفة سرية</h3>
            <form id="enter-secret-code-form">
                <div id="error-message-join-secret-room" class="error-message hidden" style="margin-bottom: 15px;"></div>
                <p style="margin-bottom:15px; text-align:center;">الغرفة "<span id="enter-secret-code-room-name-span"></span>" محمية برمز سري.</p>
                <div class="form-group">
                    <label for="join-room-secret-code-input">الرمز السري:</label>
                    <input type="password" id="join-room-secret-code-input" required>
                </div>
                <input type="hidden" id="join-room-id-hidden">
                <input type="hidden" id="join-room-name-hidden">
                <input type="hidden" id="join-room-creator-id-hidden">
                <input type="hidden" id="join-room-creator-name-hidden"> 
                <button type="submit" class="action-button">دخول</button>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onChildAdded, onChildRemoved, remove, update, serverTimestamp, query, orderByChild, off, onValue, equalTo } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8", authDomain: "story-97cf7.firebaseapp.com", databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com", projectId: "story-97cf7", storageBucket: "story-97cf7.firebasestorage.app", messagingSenderId: "742801388214", appId: "1:742801388214:web:32a305a8057b0582c5ec17", measurementId: "G-9DPPWX7CF0" };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let currentUser = null;
        let currentRoomId = 'public'; 
        let currentRoomData = { id: 'public', name: 'الدردشة العامة', type: 'public' }; 
        let messageListeners = {}; 
        let chatRequestListeners = {};
        let activePrivateChatsListener = null;
        let generalRoomsListener = null; 

        let currentMainView = 'chat'; 
        let messageSentCount = 0;

        const authPageContainer = document.getElementById('auth-page-container'); const chatPageContainer = document.getElementById('chat-page-container'); const registrationFormEl = document.getElementById('registrationForm'); const loginFormEl = document.getElementById('loginForm'); const showLoginLink = document.getElementById('show-login'); const showRegisterLink = document.getElementById('show-register'); const registerFormSection = document.getElementById('register-form-section'); const loginFormSection = document.getElementById('login-form-section'); const genderOptions = document.querySelectorAll('.gender-option'); const boyAvatarsDiv = document.getElementById('boy-avatars'); const girlAvatarsDiv = document.getElementById('girl-avatars'); const selectedAvatarInput = document.getElementById('selected-avatar'); const avatarOptions = document.querySelectorAll('.avatar-option'); const errorMessageRegisterEl = document.getElementById('error-message-register'); const successMessageRegisterEl = document.getElementById('success-message-register'); const errorMessageLoginEl = document.getElementById('error-message-login');
        const userAvatarSidebar = document.getElementById('user-avatar-sidebar'); const userNameSidebar = document.getElementById('user-name-sidebar'); const logoutButtonSidebar = document.getElementById('logout-button-sidebar'); 
        const publicChatButton = document.getElementById('public-chat-button');
        const activePrivateChatsSidebarContainer = document.getElementById('active-private-chats-sidebar'); 
        const activePrivateChatsHeader = document.getElementById('active-private-chats-header');
        const messagesContainer = document.getElementById('messages-container'); const messageInput = document.getElementById('message-input'); const sendButton = document.getElementById('send-button'); const currentChatNameHeader = document.getElementById('current-chat-name'); const notificationEl = document.getElementById('notification'); const notificationText = document.getElementById('notification-text'); const chatRequestNotificationContainer = document.getElementById('chat-request-notification-container');
        const messageInputArea = document.querySelector('.message-input-area');
        const settingsMenuToggleMobile = document.getElementById('settings-menu-toggle-mobile'); const settingsDropdownMenu = document.getElementById('settings-dropdown-menu'); const dropdownShowChatsButton = document.getElementById('dropdown-show-chats'); const dropdownLogoutButton = document.getElementById('dropdown-logout'); const mainSidebar = document.getElementById('main-sidebar'); const overlayBackdrop = document.getElementById('overlay-backdrop');
        const showRoomsPageButtonSidebar = document.getElementById('show-rooms-page-button-sidebar'); const dropdownShowRoomsPageButton = document.getElementById('dropdown-show-rooms-page'); const roomsManagementView = document.getElementById('rooms-management-view'); const roomsManagementTitle = document.getElementById('rooms-management-title'); const showCreateRoomModalButton = document.getElementById('show-create-room-modal-button'); const roomsListContainer = document.getElementById('rooms-list-container');
        const createRoomModal = document.getElementById('create-room-modal'); const closeCreateRoomModalButton = document.getElementById('close-create-room-modal-button'); const createRoomForm = document.getElementById('create-room-form'); const roomNameInput = document.getElementById('room-name-input'); const roomSecretCheckbox = document.getElementById('room-secret-checkbox'); const roomSecretCodeGroup = document.getElementById('room-secret-code-group'); const roomSecretCodeInput = document.getElementById('room-secret-code-input'); const errorMessageCreateRoom = document.getElementById('error-message-create-room');
        const enterSecretCodeModal = document.getElementById('enter-secret-code-modal'); const closeEnterSecretCodeModalButton = document.getElementById('close-enter-secret-code-modal-button'); const enterSecretCodeForm = document.getElementById('enter-secret-code-form'); const enterSecretCodeRoomNameHeader = document.getElementById('enter-secret-code-room-name-header'); const enterSecretCodeRoomNameSpan = document.getElementById('enter-secret-code-room-name-span'); const joinRoomSecretCodeInput = document.getElementById('join-room-secret-code-input'); const joinRoomIdHidden = document.getElementById('join-room-id-hidden'); const joinRoomNameHidden = document.getElementById('join-room-name-hidden'); const joinRoomCreatorIdHidden = document.getElementById('join-room-creator-id-hidden'); const joinRoomCreatorNameHidden = document.getElementById('join-room-creator-name-hidden'); const errorMessageJoinSecretRoom = document.getElementById('error-message-join-secret-room');

        // --- START: PROFANITY FILTER ---
        // ملاحظة: هذه القائمة هي مجرد مثال، ويجب عليك توسيعها بنفسك لتشمل كل الكلمات التي تريد حظرها.
        const bannedWords = [
            "احا", "شرموطة", "قحبة", "خول", "عرص", "متناك", "كس", "زب", "طيز", // كلمات بذيئة
            "حيوان", "كلب", "غبي", "حمار", // شتائم عامة
            // أضف المزيد من الكلمات هنا
        ];

        function containsProfanity(text) {
            const lowerCaseText = text.toLowerCase();
            for (const word of bannedWords) {
                if (lowerCaseText.includes(word.toLowerCase())) {
                    return true; // تم العثور على كلمة ممنوعة
                }
            }
            return false; // لا توجد كلمات ممنوعة
        }
        // --- END: PROFANITY FILTER ---

        function showGeneralNotification(message, isSuccess = true) { /* ... */ notificationText.textContent = message; notificationEl.className = isSuccess ? 'notification success' : 'notification error'; notificationEl.parentElement.classList.remove('hidden'); notificationEl.classList.add('show'); setTimeout(() => { notificationEl.classList.remove('show'); notificationEl.parentElement.classList.add('hidden'); }, 3000); }
        function displayAuthMessage(element, message, isError = true) { /* ... */ element.textContent = message; element.classList.remove(isError ? 'success-message' : 'error-message'); element.classList.add(isError ? 'error-message' : 'success-message'); element.classList.remove('hidden'); setTimeout(() => element.classList.add('hidden'), 5000); }
        showLoginLink.addEventListener('click', (e) => { /* ... */ e.preventDefault(); registerFormSection.classList.add('hidden'); loginFormSection.classList.remove('hidden'); });
        showRegisterLink.addEventListener('click', (e) => { /* ... */ e.preventDefault(); loginFormSection.classList.add('hidden'); registerFormSection.classList.remove('hidden'); });
        genderOptions.forEach(option => { /* ... */ option.addEventListener('click', () => { document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected')); option.classList.add('selected'); boyAvatarsDiv.classList.add('hidden'); girlAvatarsDiv.classList.add('hidden'); selectedAvatarInput.value = ''; document.querySelectorAll('.avatar-option.selected').forEach(opt => opt.classList.remove('selected')); if (option.dataset.gender === 'boy') boyAvatarsDiv.classList.remove('hidden'); else girlAvatarsDiv.classList.remove('hidden'); }); });
        avatarOptions.forEach(option => { /* ... */ option.addEventListener('click', () => { document.querySelectorAll('.avatar-option.selected').forEach(opt => opt.classList.remove('selected')); option.classList.add('selected'); selectedAvatarInput.value = option.src; }); });
        registrationFormEl.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const name = document.getElementById('reg-name').value.trim(); const phone = document.getElementById('reg-phone').value.trim(); const password = document.getElementById('reg-password').value; const genderOption = document.querySelector('.gender-option.selected'); const avatarUrl = selectedAvatarInput.value; if (!name || !phone || !password || !genderOption || !avatarUrl) { displayAuthMessage(errorMessageRegisterEl, "يرجى ملء جميع الحقول واختيار صورة رمزية."); return; } const gender = genderOption.dataset.gender; const userId = "user_" + phone.replace(/[^\d]/g, ""); const userRefDb = ref(database, `users/${userId}`); if ((await get(userRefDb)).exists()) { displayAuthMessage(errorMessageRegisterEl, "رقم الهاتف هذا مسجل بالفعل."); return; } try { await set(userRefDb, { name, phone, password, gender, avatarUrl, createdAt: serverTimestamp() }); displayAuthMessage(successMessageRegisterEl, "تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.", false); registrationFormEl.reset(); boyAvatarsDiv.classList.add('hidden'); girlAvatarsDiv.classList.add('hidden'); document.querySelector('.gender-option.selected')?.classList.remove('selected'); document.querySelector('.avatar-option.selected')?.classList.remove('selected'); setTimeout(() => showLoginLink.click(), 2000); } catch (error) { displayAuthMessage(errorMessageRegisterEl, "حدث خطأ أثناء التسجيل."); } });
        loginFormEl.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const phone = document.getElementById('login-phone').value.trim(); const password = document.getElementById('login-password').value; if (!phone || !password) { displayAuthMessage(errorMessageLoginEl, "يرجى إدخال رقم الهاتف وكلمة المرور."); return; } const userId = "user_" + phone.replace(/[^\d]/g, ""); const userRefDb = ref(database, `users/${userId}`); const snapshot = await get(userRefDb); if (snapshot.exists()) { const userData = snapshot.val(); if (userData.password === password) { currentUser = { id: userId, ...userData }; localStorage.setItem('chatUser', JSON.stringify(currentUser)); showChatPage(); showGeneralNotification(`مرحباً ${userData.name}! تم تسجيل الدخول بنجاح.`); } else { displayAuthMessage(errorMessageLoginEl, "كلمة المرور غير صحيحة."); } } else { displayAuthMessage(errorMessageLoginEl, "رقم الهاتف هذا غير مسجل."); } });
        function logoutUser() { Object.values(messageListeners).forEach(({ queryRef, added, removed }) => { off(queryRef, 'child_added', added); if (removed) off(queryRef, 'child_removed', removed); }); messageListeners = {}; if (chatRequestListeners.requestAdded) off(chatRequestListeners.ref, 'child_added', chatRequestListeners.requestAdded); if (chatRequestListeners.requestChanged) off(chatRequestListeners.mySentRequestsRef, 'value', chatRequestListeners.requestChanged); chatRequestListeners = {}; if(activePrivateChatsListener) off(ref(database, 'private_chat_rooms'), 'value', activePrivateChatsListener); activePrivateChatsListener = null; if (generalRoomsListener) off(ref(database, 'general_chat_rooms'), 'value', generalRoomsListener); generalRoomsListener = null; currentUser = null; localStorage.removeItem('chatUser'); showAuthPage(); showGeneralNotification("تم تسجيل الخروج بنجاح."); mainSidebar.classList.remove('sidebar-visible-mobile'); overlayBackdrop.classList.remove('active'); settingsDropdownMenu.classList.remove('active'); switchToChatView(); messageSentCount = 0; }
        function getPrivateRoomId(userId1, userId2) { return [userId1, userId2].sort().join('_direct_'); }
        async function handleUserClick(targetUserId, targetUserName, targetUserAvatar) { if (!currentUser || targetUserId === currentUser.id) return; switchToChatView(); const privateRoomId = getPrivateRoomId(currentUser.id, targetUserId); const privateRoomRefDb = ref(database, `private_chat_rooms/${privateRoomId}`); const roomSnapshot = await get(privateRoomRefDb); if (roomSnapshot.exists()) { const roomData = roomSnapshot.val(); const otherUserInfo = roomData.memberInfo?.[targetUserId] || { name: targetUserName, avatarUrl: targetUserAvatar }; switchRoom(privateRoomId, { name: `محادثة مع ${otherUserInfo.name}`, type: 'private', otherUserId: targetUserId, otherUserAvatar: otherUserInfo.avatarUrl }); mainSidebar.classList.remove('sidebar-visible-mobile'); overlayBackdrop.classList.remove('active'); return; } const requestPath1 = `chat_requests/${targetUserId}/${currentUser.id}`; const requestPath2 = `chat_requests/${currentUser.id}/${targetUserId}`; const requestSnapshot1 = await get(ref(database, requestPath1)); const requestSnapshot2 = await get(ref(database, requestPath2)); if ((requestSnapshot1.exists() && (requestSnapshot1.val().status === 'pending' || requestSnapshot1.val().status === 'accepted')) || (requestSnapshot2.exists() && (requestSnapshot2.val().status === 'pending' || requestSnapshot2.val().status === 'accepted'))) { showGeneralNotification(`لديك بالفعل طلب معلق أو محادثة قائمة مع ${targetUserName}.`, false); return; } const confirmRequest = confirm(`هل تريد بدء محادثة خاصة مع ${targetUserName}؟`); if (confirmRequest) await sendChatRequest(targetUserId, targetUserName, targetUserAvatar); }
        async function sendChatRequest(receiverId, receiverName, receiverAvatar) { const requestRefDb = ref(database, `chat_requests/${receiverId}/${currentUser.id}`); try { await set(requestRefDb, { senderId: currentUser.id, senderName: currentUser.name, senderAvatarUrl: currentUser.avatarUrl, receiverId: receiverId, receiverName: receiverName, receiverAvatarUrl: receiverAvatar, timestamp: serverTimestamp(), status: "pending" }); showGeneralNotification(`تم إرسال طلب محادثة إلى ${receiverName}.`); } catch (error) { console.error("Error sending chat request:", error); showGeneralNotification("خطأ في إرسال طلب المحادثة.", false); } }
        function displayChatRequestNotification(requestId, requestData) { const existingNotification = document.getElementById(`req-notif-${requestId}`); if (existingNotification) return; const notificationDiv = document.createElement('div'); notificationDiv.id = `req-notif-${requestId}`; notificationDiv.className = 'chat-request-notification'; notificationDiv.innerHTML = `<p>${requestData.senderName} يريد بدء محادثة خاصة معك.</p><div class="chat-request-actions"><button class="accept">قبول</button><button class="reject">رفض</button></div>`; chatRequestNotificationContainer.appendChild(notificationDiv); notificationDiv.querySelector('.accept').addEventListener('click', async () => { await handleChatRequestResponse(requestId, requestData, true); notificationDiv.remove(); }); notificationDiv.querySelector('.reject').addEventListener('click', async () => { await handleChatRequestResponse(requestId, requestData, false); notificationDiv.remove(); }); }
        async function handleChatRequestResponse(senderId, requestData, accepted) { const requestRefDb = ref(database, `chat_requests/${currentUser.id}/${senderId}`); try { if (accepted) { await update(requestRefDb, { status: "accepted" }); const privateRoomId = getPrivateRoomId(currentUser.id, senderId); const privateRoomRefDb = ref(database, `private_chat_rooms/${privateRoomId}`); const senderInfo = { name: requestData.senderName, avatarUrl: requestData.senderAvatarUrl }; const currentUserInfo = { name: currentUser.name, avatarUrl: currentUser.avatarUrl }; await set(privateRoomRefDb, { members: { [currentUser.id]: true, [senderId]: true }, memberInfo: { [currentUser.id]: currentUserInfo, [senderId]: senderInfo }, createdAt: serverTimestamp(), lastActivity: serverTimestamp() }); showGeneralNotification(`تم قبول طلب ${requestData.senderName}.`); switchToChatView(); switchRoom(privateRoomId, {name: `محادثة مع ${requestData.senderName}`, type: 'private', otherUserId: senderId, otherUserAvatar: requestData.senderAvatarUrl}); loadActivePrivateChats(); } else { await update(requestRefDb, { status: "rejected" }); showGeneralNotification(`تم رفض طلب ${requestData.senderName}.`); setTimeout(() => remove(requestRefDb), 5000); } } catch (error) { console.error("Error responding to chat request:", error); showGeneralNotification("خطأ في معالجة الطلب.", false); } }
        function listenForChatRequests() { if (!currentUser) return; const requestsPath = `chat_requests/${currentUser.id}`; const incomingRequestsRef = ref(database, requestsPath); if (chatRequestListeners.requestAdded) off(incomingRequestsRef, 'child_added', chatRequestListeners.requestAdded); chatRequestListeners.requestAdded = onChildAdded(incomingRequestsRef, (snapshot) => { const requestData = snapshot.val(); const senderId = snapshot.key; if (requestData.status === "pending") displayChatRequestNotification(senderId, requestData); }); chatRequestListeners.ref = incomingRequestsRef; const mySentRequestsQuery = query(ref(database, 'chat_requests'), orderByChild(`${currentUser.id}/senderId`), equalTo(currentUser.id)); if (chatRequestListeners.requestChanged) off(chatRequestListeners.mySentRequestsRef, 'value', chatRequestListeners.requestChanged); chatRequestListeners.requestChanged = onValue(mySentRequestsQuery, (snapshot) => { if (!snapshot.exists()) return; snapshot.forEach(receiverNode => { const requestData = receiverNode.child(currentUser.id).val(); if (!requestData || requestData.senderId !== currentUser.id) return; const receiverId = receiverNode.key; const targetUserName = requestData.receiverName || "مستخدم"; if (requestData.status === "accepted" && !requestData.notifiedAccepted) { showGeneralNotification(`${targetUserName} قبل طلب المحادثة الخاص بك.`); update(ref(database, `chat_requests/${receiverId}/${currentUser.id}`), {notifiedAccepted: true}); loadActivePrivateChats(); const privateRoomIdVal = getPrivateRoomId(currentUser.id, receiverId); switchToChatView(); switchRoom(privateRoomIdVal, { name: `محادثة مع ${targetUserName}`, type: 'private', otherUserId: receiverId, otherUserAvatar: requestData.receiverAvatarUrl}); } else if (requestData.status === "rejected" && !requestData.notifiedRejected) { showGeneralNotification(`${targetUserName} رفض طلب المحادثة الخاص بك.`); update(ref(database, `chat_requests/${receiverId}/${currentUser.id}`), {notifiedRejected: true}); setTimeout(() => remove(ref(database, `chat_requests/${receiverId}/${currentUser.id}`)), 5000); } }); }); chatRequestListeners.mySentRequestsRef = mySentRequestsQuery; }
        async function deleteMessage(msgId) { if (!confirm("هل أنت متأكد من حذف هذه الرسالة؟")) return; let path; if (currentRoomData.type === 'public') path = `public_chat_messages/${msgId}`; else if (currentRoomData.type === 'private') path = `private_chat_messages/${currentRoomId}/${msgId}`; else if (currentRoomData.type === 'group_room') path = `general_room_messages/${currentRoomId}/${msgId}`; else return; try { await remove(ref(database, path)); showGeneralNotification("تم حذف الرسالة بنجاح."); } catch (error) { console.error("Error deleting message:", error); showGeneralNotification("خطأ في حذف الرسالة.", false); } }
        function displayChatMessage(msgData, msgId) { if (document.getElementById(`msg-${msgId}`)) return; const messageElement = document.createElement('div'); messageElement.classList.add('message'); messageElement.id = `msg-${msgId}`; const isSentByUser = msgData.userId === currentUser.id; messageElement.classList.add(isSentByUser ? 'sent' : 'received'); const isRoomCreator = currentRoomData.type === 'group_room' && currentUser.id === currentRoomData.creatorId; if (!isSentByUser) { const senderInfoContainer = document.createElement('div'); senderInfoContainer.className = 'sender-info-container'; senderInfoContainer.dataset.userId = msgData.userId; senderInfoContainer.dataset.userName = msgData.userName; senderInfoContainer.dataset.userAvatar = msgData.avatarUrl; senderInfoContainer.addEventListener('click', () => handleUserClick(msgData.userId, msgData.userName, msgData.avatarUrl)); const senderAvatar = document.createElement('img'); senderAvatar.src = msgData.avatarUrl || 'https://via.placeholder.com/30'; const senderNameEl = document.createElement('span'); senderNameEl.className = 'name'; senderNameEl.textContent = msgData.userName; senderInfoContainer.appendChild(senderAvatar); senderInfoContainer.appendChild(senderNameEl); if (isRoomCreator && msgData.userId !== currentUser.id) { const banIcon = document.createElement('i'); banIcon.className = 'fas fa-user-slash ban-user-icon'; banIcon.title = `حظر ${msgData.userName} من هذه الغرفة`; banIcon.addEventListener('click', (e) => { e.stopPropagation(); promptBanUser(msgData.userId, msgData.userName, currentRoomId); }); if (document.documentElement.dir === 'rtl') { senderInfoContainer.insertBefore(banIcon, senderNameEl.nextSibling); } else { senderInfoContainer.appendChild(banIcon); } } messageElement.appendChild(senderInfoContainer); } const messageContent = document.createElement('div'); messageContent.className = 'message-content'; const textElement = document.createElement('p'); textElement.className = 'message-text'; textElement.textContent = msgData.text; messageContent.appendChild(textElement); const canDeleteThisMessage = isSentByUser || isRoomCreator; if (canDeleteThisMessage) { const deleteIcon = document.createElement('i'); deleteIcon.className = 'fas fa-trash-alt delete-msg-icon'; deleteIcon.title = 'حذف الرسالة'; if (!isSentByUser && isRoomCreator) { deleteIcon.style.color = 'var(--text-light)'; deleteIcon.onmouseover = () => deleteIcon.style.color = 'var(--accent-color)'; deleteIcon.onmouseout = () => deleteIcon.style.color = 'var(--text-light)'; } deleteIcon.addEventListener('click', () => deleteMessage(msgId)); messageContent.appendChild(deleteIcon); } messageElement.appendChild(messageContent); const timestampElement = document.createElement('span'); timestampElement.className = 'timestamp'; const timestamp = new Date(msgData.timestamp); timestampElement.textContent = timestamp.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }); messageElement.appendChild(timestampElement); messagesContainer.appendChild(messageElement); const isNearBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 100; if (isNearBottom) messagesContainer.scrollTop = messagesContainer.scrollHeight; }
        function loadMessagesForRoom(roomId, roomType) { messagesContainer.innerHTML = ''; if (messageListeners[roomId]) { off(messageListeners[roomId].queryRef, 'child_added', messageListeners[roomId].added); if (messageListeners[roomId].removed) off(messageListeners[roomId].queryRef, 'child_removed', messageListeners[roomId].removed); } let path; if (roomType === 'public') path = `public_chat_messages`; else if (roomType === 'private') path = `private_chat_messages/${roomId}`; else if (roomType === 'group_room') path = `general_room_messages/${roomId}`; else return; const messagesRefDb = ref(database, path); const messagesQuery = query(messagesRefDb, orderByChild('timestamp')); const onAdded = onChildAdded(messagesQuery, s => displayChatMessage(s.val(), s.key)); const onRemoved = onChildRemoved(messagesQuery, s => { const msgEl = document.getElementById(`msg-${s.key}`); if (msgEl) { msgEl.style.transition = 'opacity 0.5s, transform 0.5s'; msgEl.style.opacity = '0'; msgEl.style.transform = 'scale(0.8)'; setTimeout(() => msgEl.remove(), 500); } }); messageListeners[roomId] = { queryRef: messagesQuery, added: onAdded, removed: onRemoved }; setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 300); }
        function updateActiveChatAvatarsUI(isActive, roomIdToHighlight = null) { document.querySelectorAll('.private-chat-avatar-item').forEach(item => { item.classList.remove('active-priv-chat'); if (isActive && item.dataset.roomId === roomIdToHighlight) { item.classList.add('active-priv-chat'); } }); }
        function switchRoom(newRoomId, roomDetails) { currentRoomId = newRoomId; currentRoomData = { id: newRoomId, ...roomDetails }; currentChatNameHeader.textContent = currentRoomData.name; loadMessagesForRoom(newRoomId, currentRoomData.type); updateActiveChatAvatarsUI(true, newRoomId); messageInput.focus(); if (mainSidebar.classList.contains('sidebar-visible-mobile')) { mainSidebar.classList.remove('sidebar-visible-mobile'); overlayBackdrop.classList.remove('active'); } switchToChatView(); }
        function loadActivePrivateChats() { if (!currentUser) return; const sidebarScrollable = activePrivateChatsSidebarContainer.querySelector('.scrollable-y'); if (!sidebarScrollable) { activePrivateChatsSidebarContainer.innerHTML = '<h2>محادثات خاصة</h2><div class="scrollable-y"></div>'; } else { sidebarScrollable.innerHTML = ''; } activePrivateChatsHeader.innerHTML = ''; const privateChatsQuery = query(ref(database, 'private_chat_rooms'), orderByChild(`members/${currentUser.id}`), equalTo(true)); if (activePrivateChatsListener) off(privateChatsQuery, 'value', activePrivateChatsListener); activePrivateChatsListener = onValue(privateChatsQuery, (snapshot) => { const sidebarContentEl = activePrivateChatsSidebarContainer.querySelector('.scrollable-y'); sidebarContentEl.innerHTML = ''; activePrivateChatsHeader.innerHTML = ''; let hasChats = false; if (snapshot.exists()) { snapshot.forEach(roomSnap => { const roomId = roomSnap.key; const roomData = roomSnap.val(); hasChats = true; let otherUserId = Object.keys(roomData.members).find(id => id !== currentUser.id); if (otherUserId && roomData.memberInfo && roomData.memberInfo[otherUserId]) { const otherUserInfo = roomData.memberInfo[otherUserId]; const roomDisplayName = `محادثة مع ${otherUserInfo.name}`; const sidebarItem = document.createElement('div'); sidebarItem.className = 'private-chat-avatar-item'; sidebarItem.dataset.roomId = roomId; sidebarItem.innerHTML = `<img src="${otherUserInfo.avatarUrl || 'https://via.placeholder.com/35'}" alt="${otherUserInfo.name}"><span>${otherUserInfo.name}</span>`; sidebarItem.addEventListener('click', () => { switchToChatView(); switchRoom(roomId, { name: roomDisplayName, type: 'private', otherUserId: otherUserId, otherUserAvatar: otherUserInfo.avatarUrl });}); sidebarContentEl.appendChild(sidebarItem); const headerItem = document.createElement('div'); headerItem.className = 'private-chat-avatar-item'; headerItem.dataset.roomId = roomId; headerItem.innerHTML = `<img src="${otherUserInfo.avatarUrl || 'https://via.placeholder.com/30'}" alt="${otherUserInfo.name}">`; headerItem.addEventListener('click', () => { switchToChatView(); switchRoom(roomId, { name: roomDisplayName, type: 'private', otherUserId: otherUserId, otherUserAvatar: otherUserInfo.avatarUrl });}); activePrivateChatsHeader.appendChild(headerItem); } }); } if (!hasChats) sidebarContentEl.innerHTML = '<p style="padding: 0 5px; color: var(--text-light); font-size:0.9rem;">لا يوجد محادثات خاصة بعد.</p>'; updateActiveChatAvatarsUI(true, currentRoomId); }); }
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentUser) return;

            // --- START: PROFANITY CHECK ---
            if (containsProfanity(text)) {
                showGeneralNotification("رسالتك تحتوي على كلمات غير لائقة ولا يمكن إرسالها.", false);
                return; // منع إرسال الرسالة
            }
            // --- END: PROFANITY CHECK ---

            let path;
            let roomUpdatePath = null;
            if (currentRoomData.type === 'public') path = `public_chat_messages`;
            else if (currentRoomData.type === 'private') { path = `private_chat_messages/${currentRoomId}`; roomUpdatePath = `private_chat_rooms/${currentRoomId}`; }
            else if (currentRoomData.type === 'group_room') { path = `general_room_messages/${currentRoomId}`; roomUpdatePath = `general_chat_rooms/${currentRoomId}`; }
            else return;

            try {
                await push(ref(database, path), { userId: currentUser.id, userName: currentUser.name, avatarUrl: currentUser.avatarUrl, text, timestamp: serverTimestamp() });
                if (roomUpdatePath) { await update(ref(database, roomUpdatePath), { lastActivity: serverTimestamp() }); }
                messageInput.value = ''; messageInput.style.height = 'auto'; messageInput.focus();
                messageSentCount++;
                if (messageSentCount % 3 === 0) {
                    window.open('https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e', '_blank');
                }
            } catch (error) { console.error("Error sending message:", error); showGeneralNotification("حدث خطأ أثناء إرسال الرسالة.", false); }
        }

        function showAuthPage() { authPageContainer.classList.remove('hidden'); chatPageContainer.classList.add('hidden'); }
        function showChatPage() { authPageContainer.classList.add('hidden'); chatPageContainer.classList.remove('hidden'); initChatApp(); }
        function initChatApp() { if (!currentUser) return; userAvatarSidebar.src = currentUser.avatarUrl; userNameSidebar.textContent = currentUser.name; switchToChatView(); switchRoom('public', { name: 'الدردشة العامة', type: 'public' }); listenForChatRequests(); loadActivePrivateChats(); loadGeneralRooms(); }
        function switchToChatView() { currentMainView = 'chat'; messagesContainer.classList.remove('hidden'); messageInputArea.classList.remove('hidden'); roomsManagementView.classList.add('hidden'); if (currentRoomData && currentRoomData.name) { currentChatNameHeader.textContent = currentRoomData.name; } else { currentChatNameHeader.textContent = "الدردشة العامة"; } publicChatButton.classList.remove('hidden'); }
        function switchToRoomsListView() { currentMainView = 'rooms_list'; messagesContainer.classList.add('hidden'); messageInputArea.classList.add('hidden'); roomsManagementView.classList.remove('hidden'); currentChatNameHeader.textContent = "قائمة الغرف"; roomsManagementTitle.textContent = "الغرف المتاحة"; publicChatButton.classList.remove('hidden'); loadGeneralRooms(); if (mainSidebar.classList.contains('sidebar-visible-mobile')) { mainSidebar.classList.remove('sidebar-visible-mobile'); overlayBackdrop.classList.remove('active'); } settingsDropdownMenu.classList.remove('active'); }
        roomSecretCheckbox.addEventListener('change', () => { roomSecretCodeGroup.classList.toggle('hidden', !roomSecretCheckbox.checked); if (!roomSecretCheckbox.checked) { roomSecretCodeInput.value = ''; } });
        showCreateRoomModalButton.addEventListener('click', () => { createRoomForm.reset(); roomSecretCodeGroup.classList.add('hidden'); errorMessageCreateRoom.classList.add('hidden'); createRoomModal.classList.remove('hidden'); createRoomModal.classList.add('active'); roomNameInput.focus(); });
        closeCreateRoomModalButton.addEventListener('click', () => { createRoomModal.classList.remove('active'); createRoomModal.classList.add('hidden'); });
        createRoomForm.addEventListener('submit', async (e) => { e.preventDefault(); if (!currentUser) return; const roomName = roomNameInput.value.trim(); const isSecret = roomSecretCheckbox.checked; const secretCode = roomSecretCodeInput.value.trim(); if (!roomName) { displayAuthMessage(errorMessageCreateRoom, "الرجاء إدخال اسم للغرفة."); return; } if (isSecret && !secretCode) { displayAuthMessage(errorMessageCreateRoom, "الرجاء إدخال رمز سري للغرفة السرية."); return; } const newRoomRef = push(ref(database, 'general_chat_rooms')); const newRoomId = newRoomRef.key; try { const roomData = { name: roomName, creatorId: currentUser.id, creatorName: currentUser.name, isSecret: isSecret, members: { [currentUser.id]: true }, bannedUsers: {}, createdAt: serverTimestamp(), lastActivity: serverTimestamp() }; if (isSecret) { roomData.secretCode = secretCode; } await set(newRoomRef, roomData); showGeneralNotification(`تم إنشاء غرفة "${roomName}" بنجاح!`); createRoomModal.classList.remove('active'); createRoomModal.classList.add('hidden'); loadGeneralRooms(); } catch (error) { console.error("Error creating room:", error); displayAuthMessage(errorMessageCreateRoom, "حدث خطأ أثناء إنشاء الغرفة."); } });
        async function loadGeneralRooms() { if (!currentUser) return; const roomsRef = ref(database, 'general_chat_rooms'); if (generalRoomsListener) off(roomsRef, 'value', generalRoomsListener); generalRoomsListener = onValue(query(roomsRef, orderByChild('createdAt')), async (snapshot) => { roomsListContainer.innerHTML = '<p style="text-align:center; color: var(--text-light);">جاري تحميل الغرف...</p>'; if (!snapshot.exists()) { roomsListContainer.innerHTML = '<p style="text-align:center; color: var(--text-light);">لا توجد غرف متاحة حاليًا. قم بإنشاء واحدة!</p>'; return; } let roomsHtml = ''; const creatorNamePromises = []; const roomsArray = []; snapshot.forEach(roomSnap => { const roomData = roomSnap.val(); const roomId = roomSnap.key; roomsArray.push({ id: roomId, ...roomData }); }); for (const room of roomsArray) { if (!room.creatorName && room.creatorId) { creatorNamePromises.push( get(ref(database, `users/${room.creatorId}/name`)).then(nameSnap => { room.creatorNameDisplay = nameSnap.exists() ? nameSnap.val() : "غير معروف"; }) ); } else { room.creatorNameDisplay = room.creatorName || "غير معروف"; } } await Promise.all(creatorNamePromises); roomsArray.sort((a,b) => (b.lastActivity || b.createdAt) - (a.lastActivity || a.createdAt)); if (roomsArray.length === 0) { roomsListContainer.innerHTML = '<p style="text-align:center; color: var(--text-light);">لا توجد غرف متاحة حاليًا. قم بإنشاء واحدة!</p>'; return; } roomsArray.forEach(roomData => { const { id: roomId, name, creatorId, creatorNameDisplay, isSecret, members } = roomData; const isMember = members && members[currentUser.id]; let iconClass = isSecret ? "fas fa-lock" : "fas fa-users"; roomsHtml += ` <div class="room-item" data-room-id="${roomId}" data-room-name="${name}" data-is-secret="${isSecret}" data-creator-id="${creatorId}" data-creator-name="${creatorNameDisplay}"> <div class="room-item-info"> <i class="${iconClass}"></i> <div> <span class="room-name">${name}</span> <span class="room-creator">أنشأها: ${creatorNameDisplay}</span> </div> </div> <i class="fas fa-chevron-left join-room-icon"></i> </div> `; }); roomsListContainer.innerHTML = roomsHtml; document.querySelectorAll('.room-item').forEach(item => { item.addEventListener('click', async () => { const roomId = item.dataset.roomId; const roomName = item.dataset.roomName; const roomIsSecret = item.dataset.isSecret === 'true'; const roomCreatorId = item.dataset.creatorId; const roomCreatorName = item.dataset.creatorName; const roomDataSnapshot = await get(ref(database, `general_chat_rooms/${roomId}`)); if (!roomDataSnapshot.exists()) { showGeneralNotification("الغرفة لم تعد موجودة.", false); loadGeneralRooms(); return; } const currentRoomFullData = roomDataSnapshot.val(); if (currentRoomFullData.bannedUsers && currentRoomFullData.bannedUsers[currentUser.id]) { showGeneralNotification(`أنت محظور من دخول غرفة "${roomName}".`, false); return; } const isCurrentUserMember = currentRoomFullData.members && currentRoomFullData.members[currentUser.id]; if (roomIsSecret && !isCurrentUserMember) { enterSecretCodeRoomNameHeader.textContent = `دخول غرفة "${roomName}"`; enterSecretCodeRoomNameSpan.textContent = roomName; joinRoomIdHidden.value = roomId; joinRoomNameHidden.value = roomName; joinRoomCreatorIdHidden.value = roomCreatorId; joinRoomCreatorNameHidden.value = roomCreatorName; errorMessageJoinSecretRoom.classList.add('hidden'); enterSecretCodeModal.classList.remove('hidden'); enterSecretCodeModal.classList.add('active'); joinRoomSecretCodeInput.focus(); } else { switchToChatView(); switchRoom(roomId, { name: roomName, type: 'group_room', creatorId: roomCreatorId, creatorName: roomCreatorName }); } }); }); }, (error) => { console.error("Error loading general rooms:", error); roomsListContainer.innerHTML = '<p style="text-align:center; color: var(--text-light);">خطأ في تحميل الغرف.</p>'; }); }
        closeEnterSecretCodeModalButton.addEventListener('click', () => { enterSecretCodeModal.classList.remove('active'); enterSecretCodeModal.classList.add('hidden'); });
        enterSecretCodeForm.addEventListener('submit', async (e) => { e.preventDefault(); const enteredCode = joinRoomSecretCodeInput.value; const roomId = joinRoomIdHidden.value; const roomName = joinRoomNameHidden.value; const creatorId = joinRoomCreatorIdHidden.value; const creatorName = joinRoomCreatorNameHidden.value; if (!enteredCode) { displayAuthMessage(errorMessageJoinSecretRoom, "الرجاء إدخال الرمز السري."); return; } const roomRef = ref(database, `general_chat_rooms/${roomId}`); const snapshot = await get(roomRef); if (snapshot.exists()) { const roomData = snapshot.val(); if (roomData.bannedUsers && roomData.bannedUsers[currentUser.id]) { displayAuthMessage(errorMessageJoinSecretRoom, `أنت محظور من هذه الغرفة.`); enterSecretCodeModal.classList.remove('active'); enterSecretCodeModal.classList.add('hidden'); return; } if (roomData.isSecret && roomData.secretCode === enteredCode) { const updates = {}; updates[`general_chat_rooms/${roomId}/members/${currentUser.id}`] = true; await update(ref(database), updates); enterSecretCodeModal.classList.remove('active'); enterSecretCodeModal.classList.add('hidden'); joinRoomSecretCodeInput.value = ''; showGeneralNotification(`تم الانضمام إلى غرفة "${roomName}" بنجاح.`); switchToChatView(); switchRoom(roomId, { name: roomName, type: 'group_room', creatorId: creatorId, creatorName: creatorName }); } else if (roomData.isSecret && roomData.secretCode !== enteredCode) { displayAuthMessage(errorMessageJoinSecretRoom, "الرمز السري غير صحيح."); } else { displayAuthMessage(errorMessageJoinSecretRoom, "لا يمكن الانضمام لهذه الغرفة."); } } else { displayAuthMessage(errorMessageJoinSecretRoom, "الغرفة لم تعد موجودة."); enterSecretCodeModal.classList.remove('active'); enterSecretCodeModal.classList.add('hidden'); } });
        async function promptBanUser(targetUserId, targetUserName, roomId) { if (!currentUser || currentUser.id === targetUserId) return; if (currentRoomData.type !== 'group_room' || currentUser.id !== currentRoomData.creatorId) { showGeneralNotification("ليس لديك صلاحية الحظر في هذه الغرفة.", false); return; } const confirmation = confirm(`هل أنت متأكد أنك تريد حظر المستخدم "${targetUserName}" من هذه الغرفة؟ لن يتمكن من الدخول مرة أخرى.`); if (confirmation) { await banUserFromRoom(roomId, targetUserId, targetUserName); } }
        async function banUserFromRoom(roomId, userIdToBan, userNameToBan) { const roomRefDb = ref(database, `general_chat_rooms/${roomId}`); const updates = {}; updates[`bannedUsers/${userIdToBan}`] = true; updates[`members/${userIdToBan}`] = null; try { await update(roomRefDb, updates); showGeneralNotification(`تم حظر المستخدم "${userNameToBan}" من غرفة "${currentRoomData.name}" بنجاح.`); } catch (error) { console.error("Error banning user:", error); showGeneralNotification(`حدث خطأ أثناء حظر المستخدم "${userNameToBan}".`, false); } }
        showRoomsPageButtonSidebar.addEventListener('click', switchToRoomsListView);
        dropdownShowRoomsPageButton.addEventListener('click', switchToRoomsListView);
        publicChatButton.addEventListener('click', () => { switchToChatView(); switchRoom('public', { name: 'الدردشة العامة', type: 'public' }); });
        settingsMenuToggleMobile.addEventListener('click', (e) => { e.stopPropagation(); settingsDropdownMenu.classList.toggle('active'); });
        dropdownShowChatsButton.addEventListener('click', () => { mainSidebar.classList.toggle('sidebar-visible-mobile'); overlayBackdrop.classList.toggle('active', mainSidebar.classList.contains('sidebar-visible-mobile')); settingsDropdownMenu.classList.remove('active'); });
        overlayBackdrop.addEventListener('click', () => { mainSidebar.classList.remove('sidebar-visible-mobile'); overlayBackdrop.classList.remove('active'); settingsDropdownMenu.classList.remove('active'); });
        dropdownLogoutButton.addEventListener('click', () => { logoutUser(); settingsDropdownMenu.classList.remove('active'); });
        document.addEventListener('click', (e) => { if (!settingsDropdownMenu.contains(e.target) && !settingsMenuToggleMobile.contains(e.target)) { settingsDropdownMenu.classList.remove('active'); } });
        document.addEventListener('DOMContentLoaded', () => { sendButton.addEventListener('click', sendMessage); messageInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = `${Math.min(messageInput.scrollHeight, 150)}px`; }); logoutButtonSidebar.addEventListener('click', logoutUser); const storedUser = localStorage.getItem('chatUser'); if (storedUser) { try { currentUser = JSON.parse(storedUser); showChatPage(); } catch { localStorage.removeItem('chatUser'); showAuthPage(); } } else { showAuthPage(); } });
    </script>
</body>
</html>
